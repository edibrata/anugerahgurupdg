<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGRI Pandeglang Award 2025</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF & SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; min-height: 100vh; background-color: #f9fafb; }
        main { flex: 1; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #c4c4c4; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        
        .hidden { display: none; }
        
        /* Tab Style */
        .main-tab-btn { border-bottom-width: 2px; border-color: transparent; transition: all 0.2s; color: #6b7280; }
        .main-tab-btn.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .main-tab-btn:hover:not(.active) { border-color: #d1d5db; color: #374151; }
        
        .form-section-header { background-color: #eff6ff; border-left: 4px solid #4f46e5; padding: 0.75rem 1rem; margin: 1.5rem 0 1rem 0; border-radius: 0.25rem; display: flex; align-items: center; }
        .form-section-header h3 { font-size: 1.1rem; font-weight: 700; color: #1e3a8a; margin-left: 0.5rem; }
        
        .stepper-step { display: flex; flex-direction: column; align-items: center; position: relative; flex: 1; }
        .stepper-circle { width: 2.25rem; height: 2.25rem; border-radius: 9999px; background-color: #e5e7eb; color: #6b7280; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; transition: all 0.3s ease; border: 2px solid #f3f4f6; }
        .stepper-label { font-size: 0.75rem; font-weight: 600; color: #6b7280; margin-top: 0.25rem; text-align: center; }
        .stepper-line { flex-grow: 1; height: 3px; background-color: #e5e7eb; margin: 0 0.25rem; margin-bottom: 1.7rem; }
        .stepper-step.active .stepper-circle { background-color: #eef2ff; color: #4f46e5; border-color: #4f46e5; }
        .stepper-step.active .stepper-label { color: #4f46e5; }
        .stepper-step.completed .stepper-circle { background-color: #10b981; color: #ffffff; border-color: #f0fdf4; }
        .stepper-step.completed .stepper-line { background-color: #10b981; }

        .form-input-field { background-color: #f9fafb; border: 1px solid #d1d5db; color: #111827; border-radius: 0.5rem; padding: 0.625rem 1rem; width: 100%; transition: all 0.2s; }
        .form-input-field:focus { background-color: #ffffff; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); outline: none; }
        ::placeholder { color: #9ca3af; opacity: 1; }

        .sortable-header { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .sortable-header:hover { background-color: #f3f4f6; }
        .sort-icon { display: inline-block; width: 12px; height: 12px; margin-left: 4px; vertical-align: middle; }
        
        /* Table Scroll Container */
        .table-container {
            max-height: 500px; /* Scroll aktif jika tinggi melebihi 500px */
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        .table-container thead th {
            position: sticky;
            top: 0;
            background-color: #f9fafb;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        @media (max-width: 640px) {
          .stepper-line, .stepper-label { display: none; }
          .stepper-circle { width: 2rem; height: 2rem; font-size: 0.8rem; border-width: 2px; }
          #stepper-container ol { gap: 0.25rem; }
        }
    </style>
</head>
<body class="text-gray-800 antialiased text-sm">

    <!-- HEADER -->
    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-gray-200">
        <div class="container mx-auto px-4 lg:px-6">
            <div class="flex justify-between items-center h-20"> 
                <div class="flex items-center space-x-4 overflow-hidden">
                    <div class="w-14 h-14 rounded-full overflow-hidden flex-shrink-0 bg-white cursor-help" title="Logo Resmi PGRI">
                        <img class="w-full h-full object-contain" src="https://raw.githubusercontent.com/edibrata/image/main/Logo%20PGRI%20Official.png" alt="Logo PGRI">
                    </div>
                    <div class="min-w-0 flex-1 flex flex-col justify-center">
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-900 leading-tight truncate">PGRI PANDEGLANG AWARD 2025</h1>
                        <p class="text-sm font-semibold text-indigo-600 truncate">Anugerah Guru BerAKHLAK</p>
                        <p class="text-xs text-gray-500 truncate mt-0.5">Dalam Rangka Memperingati Hari Guru Nasional dan HUT Ke-80 PGRI Tahun 2025</p>
                    </div>
                </div>
                <div id="login-status" class="flex items-center gap-2 flex-shrink-0 ml-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-xs text-gray-500">Anda masuk sebagai:</p>
                        <p id="login-role-display" class="text-sm font-bold text-indigo-600">Pendaftar</p>
                    </div>
                    <button id="logout-btn" title="Keluar dari sesi" class="hidden text-xs font-medium text-white bg-red-600 hover:bg-red-700 px-3 py-1.5 rounded transition-colors flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg> Keluar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto p-3 sm:p-4 lg:p-6 max-w-7xl">

        <!-- TABS NAV -->
        <div class="mb-4">
            <div class="sm:hidden">
                <select id="main-tabs-mobile" class="block w-full text-sm rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="dashboard" selected>Dashboard Publik</option>
                    <option value="form">Formulir Pendaftaran</option>
                    <option value="juri">Juri</option>
                    <option value="admin">Admin</option>
                    <option value="superadmin">Super Admin</option>
                </select>
            </div>
            <div class="hidden sm:block">
                <div id="main-tab-nav" class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-4 lg:space-x-8" aria-label="Tabs">
                        <button class="main-tab-btn active whitespace-nowrap py-2 px-3 border-b-2 font-medium text-sm flex items-center" data-tab="dashboard" title="Lihat statistik pendaftar">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                            Dashboard Publik
                        </button>
                        <button class="main-tab-btn whitespace-nowrap py-2 px-3 border-b-2 font-medium text-sm hover:text-gray-700 hover:border-gray-300 flex items-center" data-tab="form" title="Isi formulir pendaftaran">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            Formulir Pendaftaran
                        </button>
                        <button class="main-tab-btn whitespace-nowrap py-2 px-3 border-b-2 font-medium text-sm hover:text-gray-700 hover:border-gray-300 flex items-center" data-tab="juri" title="Halaman penilaian untuk dewan juri">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" /></svg>
                            Juri
                        </button>
                        <button class="main-tab-btn whitespace-nowrap py-2 px-3 border-b-2 font-medium text-sm hover:text-gray-700 hover:border-gray-300 flex items-center" data-tab="admin" title="Halaman manajemen data untuk admin">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            Admin
                        </button>
                        <button class="main-tab-btn whitespace-nowrap py-2 px-3 border-b-2 font-medium text-sm text-red-500 hover:text-red-700 hover:border-red-300 flex items-center" data-tab="superadmin" title="Akses penuh sistem (Khusus)">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                            Super Admin
                        </button>
                    </nav>
                </div>
            </div>
        </div>

        <!-- 1. DASHBOARD -->
        <div id="main-content-dashboard" class="main-content-div">
            <!-- Status Pendaftaran -->
            <div id="public-registration-status" class="hidden mb-4 p-4 rounded-lg border shadow-sm transition-all"></div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-semibold text-gray-800">Statistik Sebaran Pendaftar</h3>
                    <div class="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md font-bold">Total: <span id="stat-total">0</span></div>
                </div>
                <div class="relative h-40 w-full"><canvas id="submissionChart"></canvas></div>
            </div>
            <h3 class="text-sm font-bold text-gray-900 mb-3 uppercase tracking-wide">Rincian Per Kategori</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3" id="dashboard-cards-container"></div>
        </div>

        <!-- 2. FORM PENDAFTARAN -->
        <div id="main-content-form" class="main-content-div hidden">
             <!-- Pesan Status Waktu Pendaftaran -->
             <div id="registration-status-message" class="hidden max-w-2xl mx-auto rounded-lg p-8 text-center border shadow-sm">
                 <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 transition-colors" id="reg-status-icon">
                     <!-- Icon injected by JS -->
                 </div>
                 <h3 class="text-lg font-bold" id="reg-status-title"></h3>
                 <p class="text-sm mt-2" id="reg-status-desc"></p>
                 <div class="mt-4 text-xs font-medium bg-gray-100 inline-block px-3 py-1 rounded text-gray-600">
                    Periode: 1 Des 2025 (00:01) - 4 Des 2025 (23:59)
                 </div>
             </div>

             <div id="view-pendaftar-select" class="hidden">
                <div class="max-w-xl mx-auto bg-white rounded-lg shadow-sm border border-gray-200 p-6 text-center mt-4">
                    <h3 class="text-lg font-bold text-gray-900 mb-1">Mulai Pendaftaran</h3>
                    <div class="mb-4">
                        <select id="kategori-select" class="block w-full text-sm rounded border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 px-3" title="Pilih kategori lomba">
                            <option value="" disabled selected>-- Pilih Kategori --</option>
                        </select>
                    </div>
                    <button id="btn-pilih-kategori" class="w-full flex justify-center items-center py-2 px-4 rounded shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition-transform" title="Lanjut ke pengisian data">Lanjutkan</button>
                </div>
            </div>
            
            <div id="view-pendaftar-form" class="hidden">
                <div id="form-card" class="max-w-3xl mx-auto bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-4 sm:p-6">
                        <button id="btn-kembali" class="mb-4 text-xs font-medium text-gray-500 hover:text-indigo-600 flex items-center" title="Kembali ke pilihan kategori"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg> Kembali</button>
                        <div id="stepper-container" class="mb-6 px-1"><ol class="flex items-center w-full"><li id="stepper-step-1" class="stepper-step active"><span class="stepper-circle">1</span><span class="stepper-label">Identitas</span></li><li class="stepper-line"></li><li id="stepper-step-2" class="stepper-step"><span class="stepper-circle">2</span><span class="stepper-label">Pegawai</span></li><li class="stepper-line"></li><li id="stepper-step-3" class="stepper-step"><span class="stepper-circle">3</span><span class="stepper-label">Unit</span></li><li class="stepper-line"></li><li id="stepper-step-4" class="stepper-step"><span class="stepper-circle">4</span><span class="stepper-label">Domisili</span></li><li class="stepper-line"></li><li id="stepper-step-5" class="stepper-step"><span class="stepper-circle">5</span><span class="stepper-label">Kontak</span></li><li class="stepper-line"></li><li id="stepper-step-6" class="stepper-step"><span class="stepper-circle">6</span><span class="stepper-label">Materi</span></li></ol></div>
                        
                        <form id="form-pendaftaran" class="space-y-6">
                            <!-- FORM CONTENT (SAMA) -->
                            <div id="form-step-1" class="form-step space-y-4">
                                <div class="form-section-header"><h3>Identitas Diri</h3></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Nama Lengkap (disertai gelar)</label><input type="text" id="nama-lengkap" class="form-input-field" placeholder="Contoh: Dr. Budi Santoso, M.Pd." required></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-700 mb-1">Tempat Lahir</label><input type="text" id="tempat-lahir" class="form-input-field" placeholder="Contoh: Pandeglang" required></div><div><label class="block text-sm font-semibold text-gray-700 mb-1">Tanggal Lahir</label><input type="date" id="tanggal-lahir" class="form-input-field" required></div></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-1">NIK (16 Digit)</label><input type="text" id="nik" pattern="\d{16}" class="form-input-field" placeholder="16 digit angka sesuai KTP" required></div>
                            </div>
                            <div id="form-step-2" class="form-step hidden space-y-4">
                                <div class="form-section-header"><h3>Data Kepegawaian</h3></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Status Kepegawaian</label><select id="status-kepegawaian" class="form-input-field" required><option value="" disabled selected>-- Pilih --</option><option value="ASN PNS">ASN PNS</option><option value="ASN PPPK">ASN PPPK</option><option value="Non ASN">Non ASN</option></select></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-700 mb-1">NIP</label><input type="text" id="nip" class="form-input-field" placeholder="Isi - jika tidak ada" required></div><div><label class="block text-sm font-semibold text-gray-700 mb-1">NUPTK</label><input type="text" id="nuptk" class="form-input-field" placeholder="16 digit angka"></div></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-700 mb-1">Pangkat/Gol</label><select id="pangkat-gol" class="form-input-field"><option value="" disabled selected>-- Pilih --</option><option value="Pengatur Muda, II/a">Pengatur Muda, II/a</option><option value="Pengatur Muda Tingkat I, II/b">Pengatur Muda Tingkat I, II/b</option><option value="Pengatur Muda, II/c">Pengatur Muda, II/c</option><option value="Pengatur Muda, II/d">Pengatur Muda, II/d</option><option value="Penata Muda, III/a">Penata Muda, III/a</option><option value="Penata Muda Tingkat I, III/b">Penata Muda Tingkat I, III/b</option><option value="Penata, III/c">Penata, III/c</option><option value="Penata Tingkat I, III/d">Penata Tingkat I, III/d</option><option value="Pembina, IV/a">Pembina, IV/a</option><option value="Pembina Tingkat I, IV/b">Pembina Tingkat I, IV/b</option><option value="Pembina Utama Muda, IV/c">Pembina Utama Muda, IV/c</option><option value="Pembina Utama Madya, IV/d">Pembina Utama Madya, IV/d</option><option value="Pembina Utama, IV/e">Pembina Utama, IV/e</option><option value="-">-</option></select></div><div><label class="block text-sm font-semibold text-gray-700 mb-1">Jabatan Fungsional</label><select id="jabatan-fungsional" class="form-input-field"><option value="" disabled selected>-- Pilih --</option><option value="Guru Ahli Pertama">Guru Ahli Pertama</option><option value="Guru Ahli Muda">Guru Ahli Muda</option><option value="Guru Ahli Madya">Guru Ahli Madya</option><option value="Guru Ahli Utama">Guru Ahli Utama</option><option value="-">-</option></select></div></div>
                            </div>
                            <div id="form-step-3" class="form-step hidden space-y-4">
                                <div class="form-section-header"><h3>Unit Kerja</h3></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-700 mb-1">Jenjang</label><select id="jenjang" class="form-input-field" required><option value="" disabled selected>-- Pilih --</option><option value="PAUD">PAUD</option><option value="SD">SD</option><option value="SMP">SMP</option><option value="SMA/SMK">SMA/SMK</option></select></div><div><label class="block text-sm font-semibold text-gray-700 mb-1">Nama Sekolah</label><input type="text" id="nama-satuan-pendidikan" class="form-input-field" placeholder="Contoh: SDN 1 Pandeglang" required></div></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Alamat Sekolah</label><input type="text" id="alamat-satuan-pendidikan" class="form-input-field" placeholder="Jl. Raya Labuan Km 5..." required></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Kecamatan Tempat Tugas</label><select id="kecamatan-satuan-pendidikan" class="form-input-field" required><option value="" disabled selected>-- Pilih --</option><option value="Angsana">Angsana</option><option value="Banjar">Banjar</option><option value="Bojong">Bojong</option><option value="Cadasari">Cadasari</option><option value="Carita">Carita</option><option value="Cibaliung">Cibaliung</option><option value="Cibitung">Cibitung</option><option value="Cigeulis">Cigeulis</option><option value="Cikedal">Cikedal</option><option value="Cikeusik">Cikeusik</option><option value="Cimanggu">Cimanggu</option><option value="Cimanuk">Cimanuk</option><option value="Cipeucang">Cipeucang</option><option value="Cisata">Cisata</option><option value="Jiput">Jiput</option><option value="Kaduhejo">Kaduhejo</option><option value="Karang Tanjung">Karang Tanjung</option><option value="Koroncong">Koroncong</option><option value="Labuan">Labuan</option><option value="Majasari">Majasari</option><option value="Mandalawangi">Mandalawangi</option><option value="Mekarjaya">Mekarjaya</option><option value="Menes">Menes</option><option value="Munjul">Munjul</option><option value="Pagelaran">Pagelaran</option><option value="Pandeglang">Pandeglang</option><option value="Panimbang">Panimbang</option><option value="Patia">Patia</option><option value="Picung">Picung</option><option value="Pulosari">Pulosari</option><option value="Saketi">Saketi</option><option value="Sindangresmi">Sindangresmi</option><option value="Sobang">Sobang</option><option value="Sukaresmi">Sukaresmi</option><option value="Sumur">Sumur</option></select></div>
                            </div>
                            <div id="form-step-4" class="form-step hidden space-y-4">
                                <div class="form-section-header"><h3>Tempat Tinggal</h3></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Alamat Rumah</label><input type="text" id="alamat-tempat-tinggal" class="form-input-field" placeholder="Kp. Ciekek..." required></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-700 mb-1">Kecamatan</label><input type="text" id="kecamatan-tempat-tinggal" class="form-input-field" placeholder="Contoh: Majasari" required></div><div><label class="block text-sm font-semibold text-gray-700 mb-1">Kota/Kabupaten</label><input type="text" id="kabupaten-kota-tempat-tinggal" class="form-input-field" placeholder="Contoh: Kabupaten Pandeglang" required></div></div>
                            </div>
                            <div id="form-step-5" class="form-step hidden space-y-4">
                                <div class="form-section-header"><h3>Kontak</h3></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-sm font-semibold text-gray-700 mb-1">WhatsApp</label><input type="tel" id="nomor-whatsapp" class="form-input-field" placeholder="08xxx" required></div><div><label class="block text-sm font-semibold text-gray-700 mb-1">Email</label><input type="email" id="email-personal" class="form-input-field" placeholder="nama@email.com" required></div></div>
                            </div>
                            <div id="form-step-6" class="form-step hidden space-y-4">
                                <div class="form-section-header"><h3>Materi Lomba</h3></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Deskripsi Singkat Inovasi</label><textarea id="deskripsi" rows="4" class="form-input-field" placeholder="Jelaskan secara singkat..." required></textarea></div>
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-2"><div class="flex"><div class="flex-shrink-0"><svg class="h-5 w-5 text-yellow-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></div><div class="ml-3"><p class="text-sm font-medium text-yellow-800">PENTING: Pastikan Link Video Google Drive diset ke <strong>Public</strong>.</p></div></div></div>
                                <div class="mt-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Link Video Karya</label><input type="url" id="tautan-video" class="form-input-field" placeholder="https://" required></div>
                                <div class="flex items-center mt-4 p-3 bg-indigo-50 rounded-lg"><input id="persetujuan" type="checkbox" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" required><label for="persetujuan" class="ml-2 block text-sm font-medium text-gray-800">Data benar & karya asli.</label></div>
                            </div>
                            <div class="mt-8 pt-6 border-t flex justify-between gap-4">
                                <button type="button" id="btn-prev" class="hidden px-6 py-2.5 rounded-lg border border-gray-300 bg-white text-gray-700 font-medium hover:bg-gray-50 flex items-center" title="Kembali ke langkah sebelumnya">Kembali</button>
                                <div class="flex-grow"></div>
                                <button type="button" id="btn-next" class="px-6 py-2.5 rounded-lg bg-indigo-600 text-white font-medium hover:bg-indigo-700 flex items-center" title="Lanjut ke langkah berikutnya">Selanjutnya</button>
                                <button type="submit" id="submit-form-btn" class="hidden px-6 py-2.5 rounded-lg bg-green-600 text-white font-bold hover:bg-green-700 flex items-center" title="Kirim formulir pendaftaran">Kirim Pendaftaran</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- JURI SECTION -->
        <div id="main-content-juri" class="main-content-div hidden">
            <div id="juri-content-wrapper" class="hidden">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
                     <div class="flex items-center space-x-2 flex-grow sm:flex-grow-0">
                         <!-- Search -->
                        <div class="relative">
                            <input type="text" id="juri-search" placeholder="Cari Nama/Sekolah..." class="border border-gray-300 text-sm rounded-lg pl-9 pr-4 py-2 focus:ring-indigo-500 focus:border-indigo-500 w-48 sm:w-64" title="Cari berdasarkan nama atau sekolah">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
                        </div>
                        <!-- Filter -->
                        <select id="juri-filter-kategori" class="border border-gray-300 text-sm rounded-lg p-2 bg-white focus:ring-indigo-500 focus:border-indigo-500" title="Filter berdasarkan kategori">
                            <option value="all">Tampilkan Semua</option>
                        </select>
                        <span class="text-sm font-medium text-gray-500 bg-white px-3 py-2 rounded-lg border border-gray-200 whitespace-nowrap" title="Jumlah data yang ditampilkan">Total: <span id="juri-total-count">0</span></span>
                    </div>
                </div>
                <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200 text-sm" id="juri-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="index" data-type="number">No</th>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="timestamp" data-type="date">Time Stamp <span class="sort-icon"></span></th>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="nama" data-type="string">Nama <span class="sort-icon"></span></th>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="kategori" data-type="string">Kategori <span class="sort-icon"></span></th>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="nilai" data-type="number">Nilai <span class="sort-icon"></span></th>
                                    <th class="px-4 py-2 text-center font-bold text-gray-500">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200 text-xs sm:text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN SECTION -->
        <div id="main-content-admin" class="main-content-div hidden">
            <div id="admin-content-wrapper" class="hidden">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
                     <div class="flex items-center space-x-2 flex-grow sm:flex-grow-0">
                         <!-- Search -->
                        <div class="relative">
                            <input type="text" id="admin-search" placeholder="Cari Nama/Sekolah..." class="border border-gray-300 text-sm rounded-lg pl-9 pr-4 py-2 focus:ring-indigo-500 focus:border-indigo-500 w-48 sm:w-64" title="Cari berdasarkan nama atau sekolah">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
                        </div>
                        <!-- Filter -->
                        <select id="admin-filter-kategori" class="border border-gray-300 text-sm rounded-lg p-2 bg-white focus:ring-indigo-500 focus:border-indigo-500" title="Filter berdasarkan kategori">
                            <option value="all">Tampilkan Semua</option>
                        </select>
                        <span class="text-sm font-medium text-gray-500 bg-white px-3 py-2 rounded-lg border border-gray-200 whitespace-nowrap" title="Jumlah data yang ditampilkan">Total: <span id="admin-total-count">0</span></span>
                    </div>
                    <button id="btn-export" class="inline-flex items-center px-4 py-2 border border-green-600 text-sm font-bold rounded-lg text-white bg-green-600 hover:bg-green-700 shadow-sm transition-colors" title="Unduh data ke file Excel">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Ekspor ke Excel
                    </button>
                </div>
                <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200 text-sm" id="admin-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="index" data-type="number">No</th>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="timestamp" data-type="date">Time Stamp <span class="sort-icon"></span></th>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="nama" data-type="string">Nama <span class="sort-icon"></span></th>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="kecSekolah" data-type="string">Kecamatan <span class="sort-icon"></span></th>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="sekolah" data-type="string">Sekolah <span class="sort-icon"></span></th>
                                    <th class="px-4 py-2 text-left font-bold text-gray-500 sortable-header" data-col="kategori" data-type="string">Kategori <span class="sort-icon"></span></th>
                                    <th class="px-4 py-2 text-center font-bold text-gray-500">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200 text-xs sm:text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SUPER ADMIN SECTION -->
        <div id="main-content-superadmin" class="main-content-div hidden">
            <div id="superadmin-content-wrapper" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="text-lg font-bold text-gray-900 mb-4 border-b pb-2">Pengaturan Sistem</h3><div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200"><div><span class="block text-sm font-bold text-gray-800">Status Pendaftaran</span><span class="text-xs text-gray-500">Buka atau tutup akses formulir.</span></div><button id="btn-toggle-registration" class="relative inline-flex items-center h-8 rounded-full w-16 transition-colors focus:outline-none bg-gray-200" title="Klik untuk mengubah status"><span class="sr-only">Toggle</span><span id="toggle-indicator" class="translate-x-1 inline-block w-6 h-6 transform bg-white rounded-full transition-transform"></span></button></div><p id="system-status-text" class="text-xs mt-2 text-right font-bold text-gray-500">Status: Memuat...</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="text-lg font-bold text-gray-900 mb-4 border-b pb-2">Tambah Pengguna</h3><form id="create-user-form" class="space-y-3"><div><label class="block text-xs font-semibold text-gray-700 mb-1">Username</label><input type="text" id="new-username" class="w-full border rounded p-2 text-sm" required></div><div><label class="block text-xs font-semibold text-gray-700 mb-1">Password</label><input type="text" id="new-password" class="w-full border rounded p-2 text-sm" required></div><div><label class="block text-xs font-semibold text-gray-700 mb-1">Role</label><select id="new-role" class="w-full border rounded p-2 text-sm"><option value="admin">Admin</option><option value="juri">Juri</option></select></div><button type="submit" id="btn-create-user" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 text-sm mt-2" title="Buat akun baru">+ Tambah User</button></form></div>
                </div>
                <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200 mb-8"><div class="px-4 py-3 bg-gray-50 border-b border-gray-200 font-bold text-sm text-gray-700">Daftar Akun</div><table class="min-w-full divide-y divide-gray-200 text-sm" id="users-table"><thead class="bg-white"><tr><th class="px-4 py-2 text-left">Username</th><th class="px-4 py-2 text-left">Role</th><th class="px-4 py-2 text-left">Aksi</th></tr></thead><tbody class="bg-white divide-y divide-gray-200 text-gray-700"></tbody></table></div>
                
                <div class="mt-6 p-4 bg-blue-50 text-blue-800 rounded-lg text-sm border border-blue-100 flex items-start"><svg class="w-5 h-5 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><p><strong>Catatan Super Admin:</strong> Gunakan tab <strong>Admin</strong> atau <strong>Juri</strong> untuk mengelola data pendaftar. Anda memiliki akses penuh.</p></div>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="bg-white border-t border-gray-200 mt-auto py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-600 font-medium text-sm">Â© 2025 PGRI Pandeglang</p>
            <p class="text-indigo-600 text-sm font-bold mt-1 tracking-wide">Managed By Edi Brata</p>
        </div>
    </footer>

    <!-- MODAL & LOGIN -->
    <div id="video-warning-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-[80] p-4 backdrop-blur-sm"><div class="bg-white rounded-lg shadow-xl max-w-lg w-full overflow-hidden transform transition-all"><div class="p-6"><div class="flex items-start"><div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 sm:mx-0 sm:h-10 sm:w-10"><svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div><div class="ml-4 text-left"><h3 class="text-lg leading-6 font-bold text-gray-900">PERHATIAN PENTING SEBELUM LANJUT</h3><div class="mt-2 text-sm text-gray-600 space-y-2"><p>Anda harus mengunggah video karya Anda ke Google Drive pribadi dan menyalin tautan (link) ke dalam formulir.</p><p class="font-medium bg-yellow-50 p-2 rounded border border-yellow-200 text-yellow-800">Pastikan SEBELUM MENGISI tautan, akses tautan video Anda sudah disetel ke "Siapa saja yang memiliki tautan dapat melihat" (Anyone with the link).</p><p>Jika akses dikunci, panitia tidak akan bisa menilai karya Anda.</p></div></div></div></div><div class="bg-gray-50 px-6 py-3 sm:flex sm:flex-row-reverse"><button type="button" onclick="closeVideoModal(true)" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">OK, saya mengerti</button><button type="button" onclick="closeVideoModal(false)" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button></div></div></div>
    <div id="login-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[90] p-4"><div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm relative"><button onclick="hideLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button><div class="flex items-center mb-6"><div class="bg-indigo-100 p-2 rounded-full mr-3"><svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div><div><h3 class="text-xl font-bold text-gray-800" id="login-modal-title">Login</h3><p class="text-xs text-gray-500">Silakan masukkan username dan password Anda.</p></div></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Username</label><input type="text" id="login-username" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"></div><div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-1">Password</label><div class="relative"><input type="password" id="login-password" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm pr-10"><button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700"><svg id="icon-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg><svg id="icon-eye-off" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.956 9.956 0 012.563-4.263m3.57-2.29A9.956 9.956 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.987 9.987 0 01-4.043 5.362M15 12a3 3 0 00-3-3m0 0a3 3 0 013 3m-3-3L3 3m9 9a3 3 0 01-3 3m0 0a3 3 0 003-3m-3 3l10 10"/></svg></button></div></div><p id="login-error" class="text-red-500 text-xs hidden mb-3 bg-red-50 p-2 rounded">Username/Password salah.</p><div class="flex justify-end gap-3"><button onclick="hideLoginModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-50 border border-gray-300 rounded-lg text-sm font-medium">Batal</button><button id="login-btn-action" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium flex items-center">Login</button></div></div></div>
    <div id="score-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] p-4"><div class="bg-white rounded-lg shadow-lg p-5 w-full max-w-sm"><h3 class="text-lg font-bold mb-2">Nilai</h3><p id="score-participant-name" class="text-xs text-gray-500 mb-3"></p><input type="hidden" id="score-doc-id"><input type="number" id="score-input" min="0" max="100" class="w-full mb-3 p-2 border rounded text-sm" placeholder="Skor (0-100)"><textarea id="score-notes" rows="2" class="w-full mb-3 p-2 border rounded text-sm" placeholder="Catatan..."></textarea><div class="flex justify-end space-x-2"><button onclick="document.getElementById('score-modal').classList.add('hidden')" class="px-3 py-1.5 text-sm border rounded">Batal</button><button id="save-score-btn" class="px-4 py-1.5 bg-green-600 text-white text-sm rounded">Simpan</button></div></div></div>
    <div id="success-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[70] p-4"><div class="bg-white rounded-lg p-6 text-center shadow-lg max-w-xs w-full"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4"><svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg></div><h3 class="text-lg font-bold text-gray-900 mb-2">Pendaftaran Berhasil!</h3><p class="text-sm text-gray-600 mb-4">Bukti pendaftaran (PDF) akan terunduh otomatis. Silakan simpan sebagai bukti.</p><button onclick="location.reload()" class="mt-4 w-full px-4 py-2 bg-indigo-600 text-white text-sm rounded">Tutup</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc, getDoc, setDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD2sIYPwmaFjElNiiaJNSqCooEzsVOX62I",
            authDomain: "pgri-award-2025.firebaseapp.com",
            projectId: "pgri-award-2025",
            storageBucket: "pgri-award-2025.firebasestorage.app",
            messagingSenderId: "550141365998",
            appId: "1:550141365998:web:a936cd15f2951497e32dff"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentRole = 'pendaftar';
        let isLoggedIn = false;
        let submissionData = [];
        let userData = []; 
        let myChart = null; 
        let currentKategori = "";
        let isRegistrationOpen = true; 
        let currentAdminFilter = 'all';
        let currentJuriFilter = 'all';
        let adminSort = { col: 'timestamp', dir: 'desc' };
        let juriSort = { col: 'timestamp', dir: 'desc' };
        let adminSearch = "";
        let juriSearch = "";

        const KATEGORI_LIST = [
            'Guru Berorientasi Pelayanan', 'Guru Akuntabel', 'Guru Kompeten', 'Guru Harmonis',
            'Guru Loyal', 'Guru Adaptif', 'Guru Kolaboratif'
        ];
        
        const KATEGORI_ICONS = {
            'Guru Berorientasi Pelayanan': '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>', 
            'Guru Akuntabel': '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>', 
            'Guru Kompeten': '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>', 
            'Guru Harmonis': '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>', 
            'Guru Loyal': '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>', 
            'Guru Adaptif': '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>', 
            'Guru Kolaboratif': '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/></svg>' 
        };

        // Init Dropdowns
        const katSelect = document.getElementById('kategori-select');
        const adminFilter = document.getElementById('admin-filter-kategori');
        const juriFilter = document.getElementById('juri-filter-kategori');
        
        KATEGORI_LIST.forEach(k => {
            const opt = document.createElement('option');
            opt.value = k; opt.textContent = k;
            katSelect.appendChild(opt);
            
            const adminOpt = document.createElement('option');
            adminOpt.value = k; adminOpt.textContent = k;
            adminFilter.appendChild(adminOpt);

            const juriOpt = document.createElement('option');
            juriOpt.value = k; juriOpt.textContent = k;
            juriFilter.appendChild(juriOpt);
        });

        // Auto-save Logic
        function loadDraft() {
            const inputs = document.querySelectorAll('#form-pendaftaran input, #form-pendaftaran select, #form-pendaftaran textarea');
            inputs.forEach(input => {
                const saved = localStorage.getItem('pgri_draft_' + input.id);
                if (saved) input.value = saved;
                input.addEventListener('input', () => {
                    localStorage.setItem('pgri_draft_' + input.id, input.value);
                });
            });
            
            const savedCat = localStorage.getItem('pgri_draft_kategori');
            if(savedCat) {
                document.getElementById('kategori-select').value = savedCat;
                currentKategori = savedCat;
                document.getElementById('view-pendaftar-select').classList.add('hidden');
                document.getElementById('view-pendaftar-form').classList.remove('hidden');
            }
        }
        
        document.getElementById('kategori-select').addEventListener('change', (e) => {
            localStorage.setItem('pgri_draft_kategori', e.target.value);
        });

        function clearDraft() {
             const inputs = document.querySelectorAll('#form-pendaftaran input, #form-pendaftaran select, #form-pendaftaran textarea');
             inputs.forEach(input => {
                 input.value = '';
                 localStorage.removeItem('pgri_draft_' + input.id);
             });
             localStorage.removeItem('pgri_draft_kategori');
             document.getElementById('kategori-select').value = "";
        }

        // Filter & Count Logic
        adminFilter.addEventListener('change', (e) => {
            currentAdminFilter = e.target.value;
            if(isLoggedIn && (currentRole === 'admin' || currentRole === 'superadmin')) {
                renderAdminTable(submissionData, currentRole === 'superadmin');
            }
        });

        juriFilter.addEventListener('change', (e) => {
            currentJuriFilter = e.target.value;
            if(isLoggedIn && (currentRole === 'juri' || currentRole === 'superadmin')) {
                renderJuriTable(submissionData);
            }
        });

        // Search Logic
        document.getElementById('admin-search').addEventListener('input', (e) => {
            adminSearch = e.target.value.toLowerCase();
            if(isLoggedIn && (currentRole === 'admin' || currentRole === 'superadmin')) renderAdminTable(submissionData, currentRole === 'superadmin');
        });

        document.getElementById('juri-search').addEventListener('input', (e) => {
            juriSearch = e.target.value.toLowerCase();
            if(isLoggedIn && (currentRole === 'juri' || currentRole === 'superadmin')) renderJuriTable(submissionData);
        });


        // Chart & Dashboard
        function initChart(data) {
            const counts = KATEGORI_LIST.map(k => data.filter(s => s.kategori === k).length);
            const ctx = document.getElementById('submissionChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: KATEGORI_LIST.map(k => k.replace('Guru ', '')),
                    datasets: [{ label: 'Pendaftar', data: counts, backgroundColor: 'rgba(79, 70, 229, 0.7)', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderDashboardCards(data) {
            const container = document.getElementById('dashboard-cards-container');
            container.innerHTML = '';
            KATEGORI_LIST.forEach(cat => {
                const count = data.filter(s => s.kategori === cat).length;
                container.innerHTML += `
                    <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition-shadow">
                        <div class="flex items-center space-x-3">
                            <div class="text-indigo-600 bg-indigo-50 p-2 rounded-lg">${KATEGORI_ICONS[cat]}</div>
                            <span class="text-xs font-medium text-gray-600">${cat.replace('Guru ', '')}</span>
                        </div>
                        <span class="text-lg font-bold text-gray-800">${count}</span>
                    </div>
                `;
            });
            document.getElementById('stat-total').innerText = data.length;
        }

        // --- LISTENERS ---
        function startListeners() {
            onSnapshot(collection(db, "submissions"), (snapshot) => {
                submissionData = [];
                snapshot.forEach((doc) => submissionData.push({ id: doc.id, ...doc.data() }));
                renderDashboardCards(submissionData);
                initChart(submissionData);
                
                if(isLoggedIn) {
                    if(currentRole === 'admin' || currentRole === 'superadmin') renderAdminTable(submissionData);
                    if(currentRole === 'juri' || currentRole === 'superadmin') renderJuriTable(submissionData);
                }
            });

            onSnapshot(collection(db, "users"), (snapshot) => {
                userData = [];
                snapshot.forEach((doc) => userData.push({ id: doc.id, ...doc.data() }));
                if(isLoggedIn && currentRole === 'superadmin') renderUserManagementTable(userData);
            });
            
            onSnapshot(doc(db, "settings", "global"), (doc) => {
                // Manual toggle still works as Super Admin override
            });
        }

        // Initialization
        function initApp() {
            loadDraft(); 
            checkRegistrationWindow(); // Initial check
            
            // Re-check every minute
            setInterval(checkRegistrationWindow, 60000);

            const session = JSON.parse(localStorage.getItem('pgri_user_session'));
            if (session) {
                isLoggedIn = true;
                currentRole = session.role;
                updateLoginUI();
                switchTabVisuals(currentRole); 
            }
            
            startListeners();
        }
        initApp();
        
        // Time-based Logic
        function checkRegistrationWindow() {
            const now = new Date();
            const start = new Date('2025-12-01T00:01:00');
            const end = new Date('2025-12-04T23:59:59');
            
            // Only auto-update if not logged in as super admin (they have toggle)
            // Or combine logic: (inTimeWindow) AND (manualSwitch !== closed)
            // For simplicity as requested: purely time based for public
            
            const statusDiv = document.getElementById('registration-status-message');
            const title = document.getElementById('reg-status-title');
            const desc = document.getElementById('reg-status-desc');
            const icon = document.getElementById('reg-status-icon');
            const publicStatus = document.getElementById('public-registration-status');

            let isOpen = false;
            let statusType = ''; // upcoming, open, closed

            if (now < start) {
                statusType = 'upcoming';
                isRegistrationOpen = false;
                title.innerText = "Pendaftaran Belum Dibuka";
                desc.innerText = "Mohon bersabar, formulir akan dibuka pada 1 Desember 2025 pukul 00:01 WIB.";
                icon.innerHTML = '<svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                icon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4";
                statusDiv.className = "max-w-2xl mx-auto bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center mb-6";
            } else if (now > end) {
                statusType = 'closed';
                isRegistrationOpen = false;
                title.innerText = "Pendaftaran Telah Ditutup";
                desc.innerText = "Periode pendaftaran telah berakhir pada 4 Desember 2025 pukul 23:59 WIB.";
                icon.innerHTML = '<svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>';
                icon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4";
                statusDiv.className = "max-w-2xl mx-auto bg-red-50 border border-red-200 rounded-lg p-8 text-center mb-6";
            } else {
                statusType = 'open';
                isRegistrationOpen = true;
            }

            // Handle visibility
            if (statusType !== 'open') {
                statusDiv.classList.remove('hidden');
                document.getElementById('view-pendaftar-select').classList.add('hidden');
                document.getElementById('view-pendaftar-form').classList.add('hidden');
                if(publicStatus) {
                    publicStatus.classList.remove('hidden', 'bg-green-50', 'text-green-800');
                    publicStatus.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                    publicStatus.innerHTML = `<strong>Status: ${statusType === 'upcoming' ? 'Belum Dibuka' : 'Ditutup'}</strong>.`;
                }
            } else {
                statusDiv.classList.add('hidden');
                 // Logic handled by closeVideoModal for showing form
                if(publicStatus) {
                    publicStatus.classList.remove('hidden', 'bg-red-50', 'text-red-800');
                    publicStatus.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
                    publicStatus.innerHTML = '<strong>Pendaftaran DIBUKA.</strong> Silakan isi formulir pendaftaran.';
                }
            }
            
            // Update Super Admin Toggle Visuals (Sync with time)
            updateRegistrationStatusUI(); 
        }

        // --- SYSTEM CONTROL UI SYNC ---
        function updateRegistrationStatusUI() {
            const statusText = document.getElementById('system-status-text');
            const toggleBtn = document.getElementById('btn-toggle-registration');
            const indicator = document.getElementById('toggle-indicator');
            
            if(statusText && toggleBtn && indicator) {
                if (isRegistrationOpen) {
                    statusText.innerText = "Status Saat Ini: DIBUKA (Sesuai Waktu)";
                    statusText.classList.remove('text-red-600'); statusText.classList.add('text-green-600');
                    toggleBtn.classList.remove('bg-gray-200'); toggleBtn.classList.add('bg-green-400');
                    indicator.classList.add('translate-x-9'); indicator.classList.remove('translate-x-1');
                } else {
                    statusText.innerText = "Status Saat Ini: DITUTUP (Sesuai Waktu)";
                    statusText.classList.remove('text-green-600'); statusText.classList.add('text-red-600');
                    toggleBtn.classList.remove('bg-green-400'); toggleBtn.classList.add('bg-gray-200');
                    indicator.classList.remove('translate-x-9'); indicator.classList.add('translate-x-1');
                }
            }
        }
        
        // Toggle Click Handler (Override for Super Admin)
        document.getElementById('btn-toggle-registration').addEventListener('click', async () => {
            if(!isLoggedIn || currentRole !== 'superadmin') return;
            alert("Sistem saat ini menggunakan Otomatisasi Waktu (1-4 Des 2025). Pengaturan manual dinonaktifkan untuk menjaga konsistensi.");
        });

        // --- SORTING HELPER ---
        function sortData(data, col, dir) {
            return [...data].sort((a, b) => {
                let valA = a[col] || '';
                let valB = b[col] || '';
                
                if (col === 'timestamp') {
                    valA = a.timestamp ? a.timestamp.seconds : 0;
                    valB = b.timestamp ? b.timestamp.seconds : 0;
                } else if (col === 'nilai') {
                    valA = Number(a.nilai || 0);
                    valB = Number(b.nilai || 0);
                } else if (col === 'index') {
                     valA = a.timestamp ? a.timestamp.seconds : 0;
                     valB = b.timestamp ? b.timestamp.seconds : 0;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return dir === 'asc' ? -1 : 1;
                if (valA > valB) return dir === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // --- RENDER ADMIN TABLE ---
        function renderAdminTable(data, isSuper = false) {
            const tableId = isSuper ? '#superadmin-table' : '#admin-table';
            const tbody = document.querySelector(`${tableId} tbody`);
            const countSpan = document.getElementById('admin-total-count');
            if(!tbody) return;
            
            // Filter Category
            let filteredData = data;
            if (currentAdminFilter !== 'all') {
                filteredData = data.filter(item => item.kategori === currentAdminFilter);
            }
            
            // Filter Search
            if (adminSearch) {
                filteredData = filteredData.filter(item => 
                    (item.nama && item.nama.toLowerCase().includes(adminSearch)) ||
                    (item.sekolah && item.sekolah.toLowerCase().includes(adminSearch))
                );
            }

            if(countSpan) countSpan.innerText = filteredData.length;
            filteredData = sortData(filteredData, adminSort.col, adminSort.dir);

            if(filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500 italic">Tidak ada data ditemukan</td></tr>';
                return;
            }

            tbody.innerHTML = filteredData.map((item, index) => {
                const date = item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString('id-ID', {dateStyle: 'medium', timeStyle: 'short'}) : '-';
                return `
                <tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="px-4 py-2 font-medium text-gray-900 text-center">${index + 1}</td>
                    <td class="px-4 py-2 text-gray-500 text-xs whitespace-nowrap">${date}</td>
                    <td class="px-4 py-2 font-medium text-gray-900">${item.nama}</td>
                    <td class="px-4 py-2 text-gray-500">${item.kecSekolah || '-'}</td>
                    <td class="px-4 py-2 text-gray-500">${item.sekolah}</td>
                    <td class="px-4 py-2 text-gray-500 text-xs"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded-full">${item.kategori.replace('Guru ', '')}</span></td>
                    <td class="px-4 py-2 flex justify-center space-x-2">
                        <a href="${item.videoUrl}" target="_blank" title="Lihat Video" class="text-indigo-600 hover:text-indigo-800 bg-indigo-50 p-1.5 rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </a>
                        <button class="btn-delete text-red-600 hover:text-red-800 bg-red-50 p-1.5 rounded-lg transition-colors" title="Hapus Data" data-id="${item.id}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            
            document.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', async (e) => { 
                if(confirm("Yakin hapus data ini?")) {
                    const id = e.currentTarget.dataset.id;
                    await deleteDoc(doc(db, "submissions", id));
                } 
            }));

            document.querySelectorAll(`${tableId} .sort-icon`).forEach(el => el.innerHTML = '');
            const activeHeader = document.querySelector(`${tableId} .sortable-header[data-col="${adminSort.col}"] .sort-icon`);
            if(activeHeader) activeHeader.innerHTML = adminSort.dir === 'asc' ? 'â²' : 'â¼';
        }

        document.querySelectorAll('#admin-table .sortable-header').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.col;
                if(adminSort.col === col) adminSort.dir = adminSort.dir === 'asc' ? 'desc' : 'asc';
                else { adminSort.col = col; adminSort.dir = 'asc'; }
                renderAdminTable(submissionData); 
            });
        });

        function renderJuriTable(data) {
            const tbody = document.querySelector('#juri-table tbody');
            const countSpan = document.getElementById('juri-total-count');
            if(!tbody) return;
            
            let filteredData = data;
            if (currentJuriFilter !== 'all') {
                filteredData = data.filter(item => item.kategori === currentJuriFilter);
            }
            
            if (juriSearch) {
                filteredData = filteredData.filter(item => 
                    (item.nama && item.nama.toLowerCase().includes(juriSearch)) ||
                    (item.sekolah && item.sekolah.toLowerCase().includes(juriSearch))
                );
            }

            if(countSpan) countSpan.innerText = filteredData.length;
            filteredData = sortData(filteredData, juriSort.col, juriSort.dir);

            if(filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500 italic">Tidak ada data ditemukan</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredData.map((item, index) => {
                const date = item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString('id-ID', {dateStyle: 'medium', timeStyle: 'short'}) : '-';
                return `
                <tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="px-4 py-2 font-medium text-gray-900 text-center">${index + 1}</td>
                    <td class="px-4 py-2 text-gray-500 text-xs whitespace-nowrap">${date}</td>
                    <td class="px-4 py-2 font-medium text-gray-900">${item.nama}</td>
                    <td class="px-4 py-2 text-gray-500 text-xs"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded-full">${item.kategori.replace('Guru ', '')}</span></td>
                    <td class="px-4 py-2 font-bold ${item.nilai ? 'text-green-600' : 'text-gray-300'}">${item.nilai || 'Belum'}</td>
                    <td class="px-4 py-2 flex justify-center space-x-2">
                        <a href="${item.videoUrl}" target="_blank" title="Tonton Video" class="text-blue-600 hover:text-blue-800 bg-blue-50 p-1.5 rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </a>
                        <button class="btn-score text-indigo-600 hover:text-indigo-800 bg-indigo-50 p-1.5 rounded-lg transition-colors" title="Nilai Peserta" data-id="${item.id}" data-name="${item.nama}" data-score="${item.nilai||0}" data-notes="${item.catatan||''}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            
            document.querySelectorAll('.btn-score').forEach(btn => btn.addEventListener('click', (e) => {
                const d = e.currentTarget.dataset;
                document.getElementById('score-doc-id').value = d.id;
                document.getElementById('score-participant-name').innerText = d.name;
                document.getElementById('score-input').value = d.score;
                document.getElementById('score-notes').value = d.notes;
                document.getElementById('score-modal').classList.remove('hidden');
            }));

            document.querySelectorAll('#juri-table .sort-icon').forEach(el => el.innerHTML = '');
            const activeHeader = document.querySelector(`#juri-table .sortable-header[data-col="${juriSort.col}"] .sort-icon`);
            if(activeHeader) activeHeader.innerHTML = juriSort.dir === 'asc' ? 'â²' : 'â¼';
        }

        document.querySelectorAll('#juri-table .sortable-header').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.col;
                if(juriSort.col === col) juriSort.dir = juriSort.dir === 'asc' ? 'desc' : 'asc';
                else { juriSort.col = col; juriSort.dir = 'asc'; }
                renderJuriTable(submissionData); 
            });
        });

        function renderUserManagementTable(users) {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = users.map(u => `
                <tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="px-4 py-2 font-medium text-gray-900">${u.username}</td>
                    <td class="px-4 py-2 text-gray-500 bg-gray-50 rounded"><span class="px-2 py-1 bg-gray-200 rounded text-xs font-bold">${u.role.toUpperCase()}</span></td>
                    <td class="px-4 py-2">
                        ${u.role !== 'superadmin' ? `<button class="btn-delete-user text-red-600 hover:text-red-800 text-xs font-bold" data-id="${u.id}" title="Hapus user">Hapus</button>` : '<span class="text-gray-400 text-xs">Locked</span>'}
                    </td>
                </tr>
            `).join('');
            
            document.querySelectorAll('.btn-delete-user').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if(confirm("Hapus user ini?")) await deleteDoc(doc(db, "users", e.target.dataset.id));
                });
            });
        }

        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('new-username').value;
            const p = document.getElementById('new-password').value;
            const r = document.getElementById('new-role').value;
            if(p.length < 6) return alert("Password minimal 6 karakter");
            try {
                const q = query(collection(db, "users"), where("username", "==", u));
                const snap = await getDocs(q);
                if(!snap.empty) return alert("Username sudah dipakai!");
                await addDoc(collection(db, "users"), { username: u, password: p, role: r });
                alert("User berhasil ditambahkan!");
                e.target.reset();
            } catch(err) { alert(err.message); }
        });

        document.getElementById('save-score-btn').addEventListener('click', async () => {
            try {
                await updateDoc(doc(db, "submissions", document.getElementById('score-doc-id').value), { nilai: document.getElementById('score-input').value, catatan: document.getElementById('score-notes').value });
                document.getElementById('score-modal').classList.add('hidden');
            } catch (e) { alert(e.message); }
        });

        window.closeVideoModal = (proceed) => {
            const modal = document.getElementById('video-warning-modal');
            modal.classList.add('hidden');
            if (proceed) {
                if (!isRegistrationOpen) {
                     document.getElementById('registration-closed-message').classList.remove('hidden');
                     document.getElementById('view-pendaftar-select').classList.add('hidden');
                } else {
                    document.getElementById('view-pendaftar-select').classList.add('hidden');
                    document.getElementById('view-pendaftar-form').classList.remove('hidden');
                }
            } else {
                document.getElementById('kategori-select').value = "";
            }
        };

        document.getElementById('btn-pilih-kategori').addEventListener('click', () => {
            if(!document.getElementById('kategori-select').value) return alert("Pilih kategori!");
            currentKategori = document.getElementById('kategori-select').value;
            document.getElementById('video-warning-modal').classList.remove('hidden');
        });

        window.showLoginModal = (role) => { 
            let displayRole = role;
            if(role === 'superadmin') displayRole = 'Super Admin';
            else displayRole = role.charAt(0).toUpperCase() + role.slice(1);
            document.getElementById('login-modal-title').innerText = `Login sebagai ${displayRole}`;
            document.getElementById('login-modal').classList.remove('hidden'); 
            document.getElementById('login-modal').dataset.role = role;
            document.getElementById('login-username').focus();
        };
        
        window.hideLoginModal = () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
        };

        document.getElementById('toggle-password').addEventListener('click', () => {
            const passwordInput = document.getElementById('login-password');
            const iconEye = document.getElementById('icon-eye');
            const iconEyeOff = document.getElementById('icon-eye-off');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                iconEye.classList.add('hidden');
                iconEyeOff.classList.remove('hidden');
            } else {
                passwordInput.type = 'password';
                iconEye.classList.remove('hidden');
                iconEyeOff.classList.add('hidden');
            }
        });

        window.handleLogin = async () => {
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            const role = document.getElementById('login-modal').dataset.role; 
            const btn = document.getElementById('login-btn-action');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Loading...'; btn.disabled = true;

            try {
                const q = query(collection(db, "users"), where("username", "==", u), where("password", "==", p), where("role", "==", role));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    isLoggedIn = true; currentRole = role; 
                    localStorage.setItem('pgri_user_session', JSON.stringify({ role: role, username: u }));
                    window.hideLoginModal(); 
                    updateLoginUI();
                    switchTabVisuals(role);
                    if(role === 'admin' || role === 'superadmin') renderAdminTable(submissionData);
                    if(role === 'juri' || role === 'superadmin') renderJuriTable(submissionData);
                    if(role === 'superadmin') renderUserManagementTable(userData);
                } else document.getElementById('login-error').classList.remove('hidden');
            } catch(e) { console.error(e); alert("Login Error: " + e.message); } 
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        };

        function updateLoginUI() {
            let roleDisplay = currentRole;
            if(currentRole === 'superadmin') roleDisplay = 'Super Admin';
            document.getElementById('login-role-display').innerText = roleDisplay.charAt(0).toUpperCase() + roleDisplay.slice(1);
            document.getElementById('logout-btn').classList.remove('hidden');
        }

        document.querySelectorAll('.main-tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetTab = e.currentTarget.dataset.tab; 
                if(['juri', 'admin', 'superadmin'].includes(targetTab)) {
                     if (!isLoggedIn || (currentRole !== targetTab && currentRole !== 'superadmin')) {
                        window.showLoginModal(targetTab);
                        return;
                     }
                }
                switchTabVisuals(targetTab);
            });
        });

        function switchTabVisuals(tabName) {
            document.querySelectorAll('.main-content-div').forEach(d => d.classList.add('hidden'));
            const content = document.getElementById(`main-content-${tabName}`);
            if(content) content.classList.remove('hidden');
            
            if(tabName === 'juri') document.getElementById('juri-content-wrapper').classList.remove('hidden');
            if(tabName === 'admin') document.getElementById('admin-content-wrapper').classList.remove('hidden');
            if(tabName === 'superadmin') document.getElementById('superadmin-content-wrapper').classList.remove('hidden');

            document.querySelectorAll('.main-tab-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.querySelector(`.main-tab-btn[data-tab="${tabName}"]`);
            if(activeBtn) activeBtn.classList.add('active');
        }
        
        document.getElementById('login-btn-action').addEventListener('click', window.handleLogin);
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('pgri_user_session');
            location.reload();
        });

        document.getElementById('main-tabs-mobile').addEventListener('change', (e) => {
             const target = e.target.value;
             if(['juri', 'admin', 'superadmin'].includes(target)) {
                 if (!isLoggedIn || (currentRole !== target && currentRole !== 'superadmin')) {
                     window.showLoginModal(target);
                     e.target.value = 'dashboard'; 
                     return;
                 }
             }
             switchTabVisuals(target);
        });

        document.getElementById('btn-kembali').addEventListener('click', () => location.reload());

        let currentStep = 1;
        const btnNext = document.getElementById('btn-next');
        const btnPrev = document.getElementById('btn-prev');
        const submitBtn = document.getElementById('submit-form-btn');

        btnNext.addEventListener('click', () => {
            const stepDiv = document.getElementById(`form-step-${currentStep}`);
            let valid = true;
            stepDiv.querySelectorAll('input[required], select[required], textarea[required]').forEach(i => { if(!i.value) { i.classList.add('border-red-500'); valid=false; } else i.classList.remove('border-red-500'); });
            if(valid && currentStep < 6) {
                document.getElementById(`form-step-${currentStep}`).classList.add('hidden');
                document.getElementById(`stepper-step-${currentStep}`).classList.remove('active');
                document.getElementById(`stepper-step-${currentStep}`).classList.add('completed');
                currentStep++;
                document.getElementById(`form-step-${currentStep}`).classList.remove('hidden');
                document.getElementById(`stepper-step-${currentStep}`).classList.add('active');
                updateNav();
            }
        });
        btnPrev.addEventListener('click', () => {
            if(currentStep > 1) {
                document.getElementById(`form-step-${currentStep}`).classList.add('hidden');
                document.getElementById(`stepper-step-${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`form-step-${currentStep}`).classList.remove('hidden');
                document.getElementById(`stepper-step-${currentStep}`).classList.remove('completed');
                document.getElementById(`stepper-step-${currentStep}`).classList.add('active');
                updateNav();
            }
        });
        function updateNav() {
            btnPrev.classList.toggle('hidden', currentStep === 1);
            btnNext.classList.toggle('hidden', currentStep === 6);
            submitBtn.classList.toggle('hidden', currentStep !== 6);
        }

        const handleExport = (role) => {
            if (submissionData.length === 0) { alert("Belum ada data."); return; }
            
            let dataToExport = submissionData;
            let categoryLabel = "Seluruh Kategori";
            
            if (role === 'admin' && currentAdminFilter !== 'all') {
                dataToExport = submissionData.filter(item => item.kategori === currentAdminFilter);
                categoryLabel = currentAdminFilter;
            }

            const mappedData = dataToExport.map(item => ({
                "Timestamp": item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString('id-ID') : '-',
                "Nama Lengkap": item.nama,
                "Tempat Lahir": item.tempatLahir,
                "Tanggal Lahir": item.tglLahir,
                "NIK": item.nik,
                "Status Kepegawaian": item.status,
                "NIP": item.nip,
                "NUPTK": item.nuptk,
                "Pangkat/Gol": item.pangkatGol,
                "Jabatan": item.jabatan,
                "Jenjang": item.jenjang,
                "Sekolah": item.sekolah,
                "Alamat Sekolah": item.alamatSekolah,
                "Kecamatan Sekolah": item.kecSekolah,
                "Alamat Rumah": item.alamatRumah,
                "Kecamatan Rumah": item.kecRumah,
                "Kab/Kota Rumah": item.kabKotaRumah,
                "WhatsApp": item.wa,
                "Email": item.email,
                "Kategori": item.kategori,
                "Deskripsi": item.deskripsi,
                "Link Video": item.videoUrl,
                "Nilai Juri": item.nilai || 0,
                "Catatan Juri": item.catatan || '-'
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(mappedData);
            
            const colWidths = Object.keys(mappedData[0] || {}).map(key => ({ wch: key.length + 5 }));
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, "Data Pendaftar");
            
            const now = new Date();
            const dateStr = now.getFullYear() +
                            String(now.getMonth() + 1).padStart(2, '0') +
                            String(now.getDate()).padStart(2, '0');
            const timeStr = String(now.getHours()).padStart(2, '0') +
                            String(now.getMinutes()).padStart(2, '0') +
                            String(now.getSeconds()).padStart(2, '0');
            
            XLSX.writeFile(wb, `PGRI Award 2025_Data Pendaftar_${categoryLabel}_${dateStr} ${timeStr}.xlsx`);
        };
        
        document.getElementById('btn-export').addEventListener('click', () => handleExport('admin'));

        async function generatePDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16); doc.setFont("helvetica", "bold");
            doc.text("BUKTI PENDAFTARAN", 105, 20, null, null, "center");
            doc.setFontSize(12); doc.text("PGRI PANDEGLANG AWARD 2025", 105, 30, null, null, "center");
            doc.line(20, 35, 190, 35);
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            let y = 50; const lineHeight = 10; const leftCol = 20; const rightCol = 80;
            const fields = [["Nama Lengkap", data.nama], ["NIK", data.nik], ["Kategori Lomba", data.kategori], ["Status Kepegawaian", data.status], ["Unit Kerja", data.sekolah], ["Kecamatan", data.kecSekolah], ["WhatsApp", data.wa], ["Tanggal Daftar", new Date().toLocaleString('id-ID')]];
            fields.forEach(([label, value]) => {
                doc.setFont("helvetica", "bold"); doc.text(label + ":", leftCol, y);
                doc.setFont("helvetica", "normal"); const splitText = doc.splitTextToSize(String(value), 110);
                doc.text(splitText, rightCol, y); y += (lineHeight * splitText.length);
            });
            y += 10; doc.setFontSize(9); doc.setFont("helvetica", "italic");
            doc.text("Simpan dokumen ini sebagai bukti pendaftaran yang sah.", 105, y, null, null, "center");
            doc.text("Panitia PGRI Pandeglang Award 2025", 105, y + 5, null, null, "center");
            doc.save(`Bukti_Pendaftaran_${data.nama.replace(/\s+/g, '_')}.pdf`);
        }

        document.getElementById('form-pendaftaran').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!isRegistrationOpen) {
                alert("Maaf, pendaftaran telah ditutup oleh panitia.");
                return;
            }
            const btn = document.getElementById('submit-form-btn');
            btn.innerText = "Mengirim..."; btn.disabled = true;
            try {
                const data = {
                    kategori: currentKategori,
                    nama: document.getElementById('nama-lengkap').value,
                    tempatLahir: document.getElementById('tempat-lahir').value,
                    tglLahir: document.getElementById('tanggal-lahir').value,
                    nik: document.getElementById('nik').value,
                    status: document.getElementById('status-kepegawaian').value,
                    nip: document.getElementById('nip').value,
                    nuptk: document.getElementById('nuptk').value,
                    pangkatGol: document.getElementById('pangkat-gol').value,
                    jabatan: document.getElementById('jabatan-fungsional').value,
                    jenjang: document.getElementById('jenjang').value,
                    sekolah: document.getElementById('nama-satuan-pendidikan').value,
                    alamatSekolah: document.getElementById('alamat-satuan-pendidikan').value,
                    kecSekolah: document.getElementById('kecamatan-satuan-pendidikan').value,
                    alamatRumah: document.getElementById('alamat-tempat-tinggal').value,
                    kecRumah: document.getElementById('kecamatan-tempat-tinggal').value,
                    kabKotaRumah: document.getElementById('kabupaten-kota-tempat-tinggal').value,
                    wa: document.getElementById('nomor-whatsapp').value,
                    email: document.getElementById('email-personal').value,
                    deskripsi: document.getElementById('deskripsi').value,
                    videoUrl: document.getElementById('tautan-video').value,
                    timestamp: serverTimestamp() 
                };
                await addDoc(collection(db, "submissions"), data);
                clearDraft();
                generatePDF(data);
                document.getElementById('success-modal').classList.remove('hidden');
            } catch (error) { alert("Error: " + error.message); } 
            finally { btn.innerText = "Kirim"; btn.disabled = false; }
        });
    </script>
</body>
</html>
